#daily

## 今日取り組んだタスク

- [ ] Railsガイド(8.1)
- [ ] スッキリわかるSQL入門


---
## 一言

やばい、、、今日1日RUNTEQのカリキュラム全然やってないっす、、、
Railsガイド見てて、入学当初に比べて読めてる！っと思って、サンプル作りながら
遊んでたら、、、夜になってました、、、
明日続きをやります、、、

---
## 学習内容
### Ruby / Rails

##### ビューに変数を渡すなら
→インスタンス変数

##### パーシャルに変数を渡すなら
→ローカル変数

##### **CSRF = Cross-Site Request Forgery（クロスサイトリクエストフォージェリ）**とは？
→「ユーザーが意図していないのに、勝手にサイトへリクエストを送られる攻撃」のこと。

例：
- ユーザーがログイン中に悪意のあるサイトが
    `POST /products` を勝手に送信する
    → 本人が送ったように見えてしまう…
    
Rails はこれを **絶対に防ぎたい！！**

仕組み（めちゃ簡単に）

1. **Rails がフォームを作るときにトークンを発行する**
2. **フォーム送信時にそのトークンも一緒に送られる**
3. **Rails サーバーが「このトークンは私（Rails）が出したものか？」をチェック**
4. 本物なら処理を続け、
    偽物なら **ActionController::InvalidAuthenticityToken** を返してブロック！

なぜ安全？

攻撃者が勝手に POST 送信する場合、**このトークンを知らないので認証できない**。
→ 攻撃は失敗する。

つまり
```ruby
<%= form_with model: @product do |form| %>
```
と書くだけで、Rails は

- authenticity_token の生成
- hidden タグへの埋め込み
- サーバー側での検証を 　**全部自動でやってくれる**。

### strong parameters

| Rails 7 以前                               | Rails 8                           |
| ---------------------------------------- | --------------------------------- |
| `params.require(:product).permit(:name)` | `params.expect(product: [:name])` |
| require で「必須キー」を指定                       | expect で「期待する構造」を示す               |
| permit で「許可キー」を指定                        | expect 返すだけで完結                    |

___
### SQL

##### 表形式の結果となる副問い合わせとは

説明：
検索結果がn行m列の表となる副問い合わせを指しています！
また、SELECT文のFROM句やINSERT文などに記述できます！

1. FROM句で利用する

具体例：
2024/01/01から2024/01/31のデータを絞った家計簿アーカイブテーブルと家計簿テーブルをUNIONで結合
それらの出金額を求める

```sql
/*家計簿テーブル*/
|日付|費目|メモ|入金額|出金額|

|2024-02-03|食費|コーヒーを購入|0|380|
|2024-02-10|給料|1月の給料|280000|0|
|2024-02-11|教養娯楽費|書籍を購入|0|2800|
|2024-02-14|交際費|同期会の会費|0|5000|
|2024-02-18|水道光熱費|1月の電気代|0|7560|

/*家計簿アーカイブ*/
|日付|費目|メモ|入金額|出金額|

|2023-12-10|給料|11月の給料|280000|0|
|2023-12-18|水道光熱費|水道代|0|4200|
|2023-12-24|食費|レストランみやび|0|5000|
|2023-12-25|居住費|1月の家賃支払い|0|80000|
|2024-01-10|給料|12月の給料|280000|0|
|2024-01-13|教養娯楽費|スッキリシネマズ|0|1800|
|2024-01-13|食費|新年会|0|5000|
|2024-01-25|居住費|2月の家賃支払い|0|80000|
```

SQL：
```sql
SELECT SUM(SUB.出金額) AS 出金額合計
FROM (SELECT 日付, 費目, 出金額
      FROM 家計簿
      UNION
      SELECT 日付, 費目, 出金額
      FROM 家計簿アーカイブ
      WHERE 日付 >= '2024-01-01'
      AND 日付 <= '2024-01-31') AS SUB
```

出力：
```sql
|出金額合計|
|102540|
```


2. INSERT文利用する

説明：
INSERT文は、原則として
1回の呼び出しで1行しか追加することができません！
ですので
100行分のデータを追加したい場合は、100回のINSERT文を実行する必要があります！
めっちゃ大変っす
しかし、副問い合わせを使えば、1回のINSERT文で複数行のデータ登録が可能になります！
「一度の操作でまとめて処理する」という点では、「includes」に似ているかも？？？

具体例：

```sql
/*家計簿テーブル*/
|日付|費目|メモ|入金額|出金額|

|2024-02-03|食費|コーヒーを購入|0|380|
|2024-02-10|給料|1月の給料|280000|0|
|2024-02-11|教養娯楽費|書籍を購入|0|2800|
|2024-02-14|交際費|同期会の会費|0|5000|
|2024-02-18|水道光熱費|1月の電気代|0|7560|
|2024-02-19|食費|後輩と飲み会|0|5200|

/*家計簿アーカイブテーブル*/
|費目|合計|平均|最大|最小|回数|

/*レコードなし*/
```

SQL：
```sql
INSERT INTO 家計簿集計(費目, 合計, 平均, 回数)
SELECT 費目, SUM(出金額), AVG(出金額), 0
  FROM 家計簿
 WHERE 出金額 > 0
 GROUP BY 費目
```

補足
今回の副問い合わせは、（）で括られてません。このパターンだけは特例で、副問い合わせではなく
INSERT文の特殊構文です！
もし、副問い合わせの結果表の列と登録するテーブルの列が完全一致すれば
INSERTの列指定は省略することができます！
追記：
副問い合わせ、、、混乱する、、、、

出力：
```sql
|費目|合計|平均|最大|最小|回数|
|---|---|---|---|---|---|
|食費|5580|2790|||0|
|交際費|5000|5000|||0|
|教養娯楽費|2800|2800|||0|
|水道光熱費|7560|7560|||0|
```

---
## 学んだこと

Ruby on Rails
- ビューやパーシャルに渡す変数
- CSRF = Cross-Site Request Forgeryについて
- Rails7とRails８においてのstrong parametersについて

SQL
- 表形式の結果となる副問い合わせについて


---
## 教材

- スッキリわかるSQL入門
- Railsガイド


---
---
##### ⏳ 学習時間:8 時間  
##### 🌱 コミット数: ３コミット
