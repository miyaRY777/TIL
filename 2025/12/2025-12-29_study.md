

## 実装内容の概要

- 投稿（Post）に対して複数タグ（Tag）を付与できる機能を実装
- 中間テーブル（PostTag）を用いた多対多の関連付け
- タグの新規作成・再利用・重複防止・空文字除外に対応
- 編集・一覧表示・N+1問題対策まで実装

---

## 全体の流れ

1. モデル作成 + 関連付け定義 + 一意制約追加
2. 関連付けの動作確認（コンソール）
3. PostsController + CRUD を最低限作成
4. Postのみ保存できるか確認（タグなし）
    
5. タグ入力欄の動作確認（getter / setter）
6. タグ保存ロジックの実装
7. 新規・既存・重複タグの確認
8. 空文字列除外の確認
    
9. 投稿失敗時の入力保持確認
10. 編集画面の表示・更新確認
11. 一覧表示（N+1対策）の確

---

## ① モデル作成 + 関連付け定義 + 一意制約追加

### モデル・マイグレーション作成

```bash
bin/rails g model Post title:string body:text
bin/rails g model Tag name:string
bin/rails g model PostTag post:references tag:references
```

### 中間テーブルに一意制約を追加

```ruby
add_index :post_tags, [:post_id, :tag_id], unique: true
```

### モデルの関連付け

```ruby
# app/models/post.rb
class Post < ApplicationRecord
  has_many :post_tags, dependent: :destroy
  has_many :tags, through: :post_tags

  attr_accessor :tag_list

  validates :title, presence: true
  validates :body, presence: true
end
```

```ruby
# app/models/tag.rb
class Tag < ApplicationRecord
  has_many :post_tags, dependent: :destroy
  has_many :posts, through: :post_tags

  validates :name, presence: true, uniqueness: true
end
```

---

## ② 関連付けの動作確認（コンソール）

```bash
bin/rails c
```

```ruby
post = Post.create!(title: 'テスト投稿', body: '本文')
tag  = Tag.create!(name: 'rails')

post.tags << tag

post.tags.pluck(:name)
# => ["rails"]
```

同一タグを再度追加すると一意制約によりエラーが発生することを確認。

---

## ③ PostsController + CRUD を最低限作成

```bash
bin/rails g controller Posts index new create edit update show destroy
```

```ruby
def index
  @posts = Post.includes(:tags).order(created_at: :desc)
end
```

---

## ④ Postのみ保存できるか確認（タグなし）

- タイトル・本文のみ入力
- 投稿が正常に保存され、一覧・詳細画面で表示されることを確認

```ruby
Post.last.title
Post.last.body
```

---

## ⑤ タグ入力欄の動作確認（getter / setter）

### フォームにタグ入力欄を追加

```erb
<%= f.label :tag_list, 'タグ' %>
<%= f.text_field :tag_list, placeholder: 'rails,ruby,php' %>
```

### getter / setter 実装

```ruby
def tag_list
  @tag_list || tags.pluck(:name).join(',')
end
```

- setter に設定した値が優先される
- 未設定時は DB のタグを取得
    
---

## ⑥ タグ保存ロジックの実装

```ruby
def save_tags
  return if tag_list.blank?

  post_tags.destroy_all

  tag_names = tag_list.split(',')
                      .map(&:strip)
                      .reject(&:blank?)
                      .uniq

  tag_names.each do |name|
    tag = Tag.find_or_create_by!(name: name)
    tags << tag unless tags.include?(tag)
  end
end
```

---

## ⑦ 新規・既存・重複タグの確認

- 新規タグは作成される```
```ruby
# コンソールを起動
bin/rails c

# 既存のタグを確認
Tag.pluck(:name)
# => []（まだタグがない）

# 新規投稿を作成
post = Post.new(title: 'テスト', body: '本文', tag_list: 'rails,ruby,php')
post.save
post.save_tags

# タグが作成されているか確認
Tag.pluck(:name)
# => ["rails", "ruby", "php"]

# 投稿に紐づいているか確認
post.tags.pluck(:name)
# => ["rails", "ruby", "php"]
```

- 既存タグは再利用される
```ruby
# 同じタグを含む投稿を作成
post2 = Post.new(title: 'テスト2', body: '本文2', tag_list: 'rails,ruby,java')
post2.save
post2.save_tags

# タグの総数を確認
Tag.count
# => 4（rails, ruby, php, java）

# railsとrubyは再利用されている
Tag.where(name: ['rails', 'ruby']).count
# => 2（重複していない）

# post2のタグを確認
post2.tags.pluck(:name)
# => ["rails", "ruby", "java"]
```

- 入力時の重複は除外される
```ruby
# 同じタグを複数回入力
post3 = Post.new(title: 'テスト3', body: '本文3', tag_list: 'rails,rails,ruby,ruby')
post3.save
post3.save_tags

# 重複が除外されているか確認
post3.tags.pluck(:name)
# => ["rails", "ruby"]（重複が除外されている）
```


---

## ⑧ 空文字列除外の確認

```ruby
tag_list: 'rails,,ruby, ,php'
# => ["rails", "ruby", "php"]
```

動作確認
```
# コンソールを起動
bin/rails c

# 空文字を含む入力
post = Post.new(title: 'テスト', body: '本文', tag_list: 'rails,,ruby,  ,php')
post.save
post.save_tags

# 空文字が除外されているか確認
post.tags.pluck(:name)
# => ["rails", "ruby", "php"]
```

---

## ⑨ 投稿失敗時の入力保持確認

- バリデーションエラー時も `tag_list` が保持される
- フォーム再表示時に入力内容が残ることを確認

#### ブラウザで確認

1. **新規投稿画面にアクセス**

```
http://localhost:3000/posts/new
```

2. **タイトルを空にして投稿**

- タイトル: （空欄）
- 本文: テスト本文
- タグ: `rails,ruby,php`
- 「投稿」ボタンをクリック

3. **エラーメッセージが表示されるか確認**

```
Title can't be blank
```

4. **タグの入力が保持されているか確認**

- タグ入力欄に `rails,ruby,php` が残っている

✅ **投稿失敗時もタグの入力が保持されている**

### 9-2. コンソールで確認

```
# コンソールを起動
bin/rails c

# バリデーションエラーを発生させる
post = Post.new(title: '', body: '本文', tag_list: 'rails,ruby,php')
post.save
# => false

# tag_listが保持されているか確認
post.tag_list
# => "rails,ruby,php"

# エラーメッセージを確認
post.errors.full_messages
# => ["Title can't be blank"]
```

✅ **バリデーションエラー時も@tag_listが保持されている**


---

## ⑩ 編集画面の表示・更新確認

- 編集画面で既存タグが表示される
- 更新後、タグが正しく差し替わる

```ruby
<!-- app/views/posts/show.html.erb -->

<!-- タグ表示を追加 -->
<div class="tags">
  <strong>タグ:</strong>
  <% if @post.tags.any? %>
    <%= @post.tags.pluck(:name).join(', ') %>
  <% else %>
    なし
  <% end %>
</div>

<!-- app/views/posts/_post.html.erb -->

<!-- タグ表示をここに追加 -->
<div class="mt-1">
	<strong>タグ:</strong>
	<% if post.tags.any? %>
		<%= post.tags.pluck(:name).join(', ') %>
	<% else %>
		<span class="text-muted">なし</span>
	<% end %>
</div>

```

### . 編集画面の動作確認

#### ブラウザで確認

1. **投稿を作成**

- タイトル: テスト投稿
- 本文: テスト本文
- タグ: `rails,ruby,php`

2. **投稿詳細画面でタグが表示されるか確認**

```
タグ: rails, ruby, php
```

3. **編集画面にアクセス**
- 「編集」リンクをクリック

3. **タグ入力欄に既存のタグが表示されているか確認**
- タグ入力欄: `rails,ruby,php`

3. **タグを変更して更新**
- タグ: `rails,java,python`（rubyとphpを削除、javaとpythonを追加）
- 「投稿」ボタンをクリック

6. **投稿詳細画面で確認**

```
タグ: rails, java, python
```


---

## ⑪ 一覧表示（N+1対策）の確認

```ruby
@posts = Post.includes(:tags)
```

- SQL が 2 回のみ実行されることをログで確認
    
- includes を外すと N+1 が発生することも確認
    

---

## ⑫ RSpec 実行

```bash
bundle exec rspec
```

```text
XX examples, 0 failures
```

---

## 最終確認

- 関連付け・一意制約が正しく機能している
    
- タグの登録・更新・表示がすべて正常
    
- N+1問題が発生していない
    
- RSpec が成功する
    

---

以上で **タグ機能実装の手順書**は完了です。

---

もし次に進むならおすすめは👇

- README を **さらに短くして「提出用」最終版にする**
    
- **設計意図・工夫点・詰まった点**を追記（加点されやすい）
    

どこまで仕上げるか、決めましょうか。


## ⑪ 一覧表示（N+1対策）の確認

### 11-1. 一覧画面にタグを表示

```
<!-- app/views/posts/index.html.erb -->
<h1>投稿一覧</h1>

<%= link_to '新規投稿', new_post_path %>

<div class="posts">
  <% @posts.each do |post| %>
    <div class="post">
      <h2><%= link_to post.title, post %></h2>
      <p><%= post.body %></p>
      
      <!-- タグ表示を追加 -->
      <div class="tags">
        <strong>タグ:</strong>
        <% if post.tags.any? %>
          <%= post.tags.pluck(:name).join(', ') %>
        <% else %>
          なし
        <% end %>
      </div>
    </div>
  <% end %>
</div>
```

### 11-2. N+1問題の確認

#### コントローラーを確認

```ruby
# app/controllers/posts_controller.rb
def index
  @posts = Post.includes(:tags).order(created_at: :desc)
  # ↑ includes(:tags)でN+1問題を解決
end
```


## ⑫ タグ検索機能の実装

### 12-1. タグで絞り込む検索機能を追加

#### コントローラーに検索処理を追加

```
# app/controllers/posts_controller.rb
class PostsController < ApplicationController
  before_action :set_post, only: %i[show edit update destroy]

  def index
    @posts = Post.includes(:tags).order(created_at: :desc)
    
    # タグで絞り込み
    if params[:tag].present?
      @posts = @posts.joins(:tags).where(tags: { name: params[:tag] })
    end
  end

  # 以下省略
end
```

#### ビューに検索リンクを追加

```
<!-- app/views/posts/index.html.erb -->
<h1>投稿一覧</h1>

<%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>

<div class="posts">
  <% @posts.each do |post| %>
    <div class="post">
      <h2><%= link_to post.title, post %></h2>
      <p><%= post.body %></p>
      
      <div class="tags">
        <strong>タグ:</strong>
        <% if post.tags.any? %>
          <% post.tags.each do |tag| %>
            <%= link_to tag.name, posts_path(tag: tag.name), class: 'badge bg-secondary' %>
          <% end %>
        <% else %>
          なし
        <% end %>
      </div>
    </div>
  <% end %>
</div>
```

---

### 12-2. 動作確認

1. **投稿を作成**

- 投稿1: タグ「rails, ruby」
- 投稿2: タグ「rails, php」
- 投稿3: タグ「java, python」

2. **一覧画面でタグをクリック**

- 「rails」タグをクリック
- 投稿1と投稿2だけが表示される

✅ **タグで絞り込みができている**


## ⑬ まとめ

### 実装した機能

1. ✅ **タグモデルの作成**
    
    - Tagモデル、PostTagモデル（中間テーブル）を作成
    - 多対多のリレーションを設定
2. ✅ **タグ入力フォームの実装**
    
    - `tag_list`属性を追加（仮想属性）
    - カンマ区切りで入力できるフォームを実装
3. ✅ **タグ保存ロジックの実装**
    
    - `save_tags`メソッドで保存処理を実装
    - 新規タグの作成、既存タグの再利用
    - 重複・空文字の除外
4. ✅ **タグ表示機能の実装**
    
    - 一覧・詳細画面でタグを表示
    - N+1問題の対策（includes）
5. ✅ **タグ検索機能の実装**
    
    - タグで投稿を絞り込む機能