

### å…¨ä½“ã®æµã‚Œ
```ruby
ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  â†“
params ã«å¤‰æ›
  â†“
Controller ãŒ params ã‚’æ¸¡ã™
  â†“
Model(scope) ãŒæ¡ä»¶ã‚’çµ„ã¿ç«‹ã¦ã‚‹
  â†“
ActiveRecord::Relation ãŒå®Œæˆ
  â†“
View ã§åˆã‚ã¦ SQL å®Ÿè¡Œ
  â†“
çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹

```

## 1. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´ï¼‰

ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ã¨ã€  
**å„ `<input>` ã® `name` ã¨ `value` ãŒã‚»ãƒƒãƒˆ**ã«ãªã£ã¦é€ã‚‰ã‚Œã¾ã™ã€‚
```ruby
<input name="post" value="Ruby">
<input name="comment" value="æ¥½ã—ã„"> 
<input name="user" value="ç”°ä¸­">
```
â¬‡ï¸  
HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
`GET /posts?post=Ruby&comment=æ¥½ã—ã„&user=ç”°ä¸­`

---

## 2. Railsã«å±Šã„ãŸæ™‚ï¼ˆparamsï¼‰

Railsã¯ã“ã‚Œã‚’ **Hashå½¢å¼** ã«å¤‰æ›ã—ã¾ã™ã€‚

```ruby
params[:post]    #=> "Ruby" 
params[:comment] #=> "æ¥½ã—ã„" 
params[:user]    #=> "ç”°ä¸­"
```
ğŸ‘‰ ã“ã“ã§ã¯ **ã¾ã ä½•ã‚‚æ¤œç´¢ã—ã¦ã„ãªã„**  
ğŸ‘‰ ãŸã ã€Œå€¤ã‚’å—ã‘å–ã£ãŸã ã‘ã€

---

## 3. Controller ãŒ params ã‚’å—ã‘å–ã‚‹
```ruby
class PostsController < ApplicationController
   def index
        @posts = Post.order(created_at: :desc)
        @posts = @posts.search_by_title_or_body(params[:post])
        @posts = @posts.search_by_comment(params[:comment])
        @posts = @posts.search_field_of_user(params[:user])
        @posts = @posts.distinct
    end
end
```
### é‡è¦ãƒã‚¤ãƒ³ãƒˆ

- `@posts` ã¯ **ActiveRecord::Relation**
- 1è¡Œãšã¤ã€Œæ¡ä»¶ã‚’ç©ã¿ä¸Šã’ã¦ã„ã‚‹ã€ã ã‘
- **ã¾ã SQLã¯å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„**

---

## 4. Modelï¼ˆscopeï¼‰ãŒ params ã‚’è©•ä¾¡ã™ã‚‹

### ä¾‹â‘  ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡æ¤œç´¢

```ruby
scope :search_by_title_or_body, ->(keyword) {
  return all if keyword.blank?

  where(
    'posts.title LIKE :q OR posts.body LIKE :q',
    q: "%#{keyword}%"
  )
}
```

#### params ãŒã‚ã‚‹å ´åˆ

```ruby
params[:post] #=> "Ruby"
```

â¬‡ï¸  
Relation ã«è¿½åŠ ã•ã‚Œã‚‹æ¡ä»¶

```sql
WHERE (posts.title LIKE '%Ruby%' OR posts.body LIKE '%Ruby%')
```

---

### ä¾‹â‘¡ ã‚³ãƒ¡ãƒ³ãƒˆæ¤œç´¢

```ruby
scope :search_by_comment, ->(keyword) {
  return all if keyword.blank?

  left_joins(:comments)
    .where('comments.body LIKE ?', "%#{keyword}%")
}
```

#### params ãŒã‚ã‚‹å ´åˆ

```ruby
params[:comment] #=> "æ¥½ã—ã„"
```

â¬‡ï¸  
Relation ã«è¿½åŠ ã•ã‚Œã‚‹æ¡ä»¶

```sql
LEFT JOIN comments
  ON comments.post_id = posts.id
WHERE comments.body LIKE '%æ¥½ã—ã„%'
```

---

### ä¾‹â‘¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¤œç´¢

```ruby
scope :search_field_of_user, ->(keyword) {
  return all if keyword.blank?

  joins(user: :profile)
    .where('profiles.name LIKE ?', "%#{keyword}%")
}
```

---

## 5. Relation ãŒæœ€çµ‚çš„ã«å®Œæˆã™ã‚‹

Controllerã®ä¸­ã§ã¯ã€å®Ÿéš›ã«ã¯ã“ã†ãªã£ã¦ã„ã¾ã™ğŸ‘‡

```ruby
@posts =
  Post
    .order(created_at: :desc)
    .where(posts.title LIKE '%Ruby%' OR posts.body LIKE '%Ruby%')
    .left_joins(:comments)
    .where(comments.body LIKE '%æ¥½ã—ã„%')
    .joins(user: :profile)
    .where(profiles.name LIKE '%ç”°ä¸­%')
    .distinct
```

ğŸ‘‰ **ã“ã®æ™‚ç‚¹ã§ã‚‚SQLã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„**

---

## 6. Viewã§åˆã‚ã¦SQLãŒå®Ÿè¡Œã•ã‚Œã‚‹

```erb
<% @posts.each do |post| %>
  <%= post.title %>
<% end %>
```

â¬‡ï¸  
ã“ã“ã§ Rails ãŒ DB ã«å•ã„åˆã‚ã›ã‚‹

```sql
SELECT DISTINCT posts.*
FROM posts
LEFT JOIN comments ON comments.post_id = posts.id
INNER JOIN users ON users.id = posts.user_id
INNER JOIN profiles ON profiles.user_id = users.id
WHERE
  (posts.title LIKE '%Ruby%' OR posts.body LIKE '%Ruby%')
  AND comments.body LIKE '%æ¥½ã—ã„%'
  AND profiles.name LIKE '%ç”°ä¸­%'
ORDER BY posts.created_at DESC;
```
