
# TIL：タグ機能をテスト駆動開発で実装する考え方

## 今日学んだこと

プロフィールの **趣味タグ機能** を、
いきなり画面やコントローラから作らず、**テスト駆動開発（TDD）** で段階的に設計・実装する方法を学んだ。

---

## 1. まず「パース処理」を純粋関数として切り出す

### 目的

* `rails,ruby, php , ,` のような入力を
  **正規化された配列**に変換する

### ポイント

* DB / ActiveRecord に依存しない
* 副作用なし（入力 → 出力が常に同じ）
* Rails外でもテストできる

### テスト（RED）

```ruby
RSpec.describe HobbyNamesParser do
  describe ".call" do
    it "カンマ区切りを配列にする" do
      expect(described_class.call("rails,ruby")).to eq(%w[rails ruby])
    end
  end
end
```

### 実装（GREEN）

```ruby
class HobbyNamesParser
  def self.call(raw)
    raw.to_s
       .split(",")
       .map(&:strip)
       .reject(&:blank?)
       .uniq
  end
end
```

---

## 2. タグのモデル設計（多対多）

### 構成

* Profile
* Hobby
* ProfileHobby（中間テーブル）

### 関連付け

```ruby
class Profile < ApplicationRecord
  has_many :profile_hobbies, dependent: :destroy
  has_many :hobbies, through: :profile_hobbies
end

class Hobby < ApplicationRecord
  has_many :profile_hobbies, dependent: :destroy
  has_many :profiles, through: :profile_hobbies

  validates :name, presence: true, uniqueness: true
end

class ProfileHobby < ApplicationRecord
  belongs_to :profile
  belongs_to :hobby

  validates :hobby_id, uniqueness: { scope: :profile_id }
end
```

### 学び

* 同じタグを **同じプロフィールに二重登録させない**
  → `scope: :profile_id` を使う

---

## 3. RSpec の `let` と FactoryBot の役割

### 定義

```ruby
let(:profile) { create(:profile) }
```

### 意味

* `profile` を **初めて使ったタイミングで**
* FactoryBot を使って **DBに保存済みの Profile を作成**
* 同じ example 内では同一オブジェクトが再利用される

### なぜ `create`？

* 中間テーブルや関連付けのテストでは
  **DBに存在するレコードが必要**なため
* `build` では不十分

---

## 4. TDDで意識した設計思想

* いきなりコントローラを書かない
* ロジックは Service / Parser に切り出す
* 「1つの責務・1つの入口」
* テストしやすい順に作る

  1. 純粋関数
  2. モデル
  3. 保存処理
  4. 画面・コントローラ

