
---

# ✅ `authenticates_with_sorcery!` の実用解説

---

## 1. コードの必要性

ユーザー登録やログインを安全に実装するには、本来こうした仕組みが必要です。

* パスワードを **仮想属性** として扱う（DBに平文で保存しない）
* 保存前に暗号化し、`crypted_password` と `salt` を保存
* ログイン時に入力値を暗号化し、DBの値と比較

👉 これを全部自分で書くのは危険（バグやセキュリティリスク）。
そこで **`authenticates_with_sorcery!` をUserモデルに書くだけで、自動的に導入**されます。

---

## 2. コードの処理

```ruby
# app/models/user.rb
class User < ApplicationRecord
  authenticates_with_sorcery!   # ← Sorceryの認証機能が有効に！

  validates :email, presence: true, uniqueness: true
end
```

この1行により以下が提供されます。

1. `password` 仮想属性が使えるようになる
2. 保存時に `crypted_password` と `salt` が自動で生成される
3. `User.authenticate(email, password)` で認証できる

補足
- - validates で定義したバリデーションは、save・create・update 系のメソッドが呼ばれるタイミングで実行

---

## 3. データの流れ（実用例）

### 🔹 新規登録時

#### ビュー（フォーム）

```erb
<%= form_with model: @user, url: users_path do |f| %>
  <%= f.email_field :email %>
  <%= f.password_field :password %>   <!-- 仮想属性 -->
  <%= f.submit "登録" %>
<% end %>
```

---

#### コントローラー

```ruby
class UsersController < ApplicationController
  def create
    # ブラウザがフォーム送信 → params に値が乗る
    # user_params が require/permit で安全な値だけ抽出
    # User.new(...) で未保存オブジェクト生成
    @user = User.new(user_params)
    # save 実行 → バリデーション・コールバック → 成否で分岐
    if @user.save
      redirect_to root_path, notice: "登録完了！"
    else
      render :new
    end
  end

  private
  def user_params
    params.require(:user).permit(:email, :password)
  end

  補足
  - 「userキーが必須で、その中のemailとpasswordだけを使えるようにする」安全フィルター
end
 
```

---

#### モデル処理（裏側）

1. `authenticates_with_sorcery!` により `password` を受け取る
2. Sorceryが保存前に
   * ランダムな `salt` を生成
   * `password + salt` を暗号化して `crypted_password` に保存
3. DBに保存される

---

#### DBイメージ

| email                                       | crypted_password     | salt     |
| ------------------------------------------- | --------------------- | -------- |
| [taro@example.com](mailto:taro@example.com) | "a9f1c9d0e..." (ハッシュ) | "xYz123" |

👉 平文パスワードは保存されない！

---

### 🔹 ログイン時

#### ビュー（フォーム）

```erb
<%= form_with url: login_path do |f| %>
  <%= f.email_field :email %>
  <%= f.password_field :password %>
  <%= f.submit "ログイン" %>
<% end %>
```

---

#### コントローラー（例）

```ruby
class SessionsController < ApplicationController
  def create
    user = User.authenticate(params[:email], params[:password])
    if user
      auto_login(user)  # ← Sorceryのログイン補助メソッド
      redirect_to root_path, notice: "ログイン成功"
    else
      flash.now[:alert] = "メールアドレスまたはパスワードが違います"
      render :new
    end
  end
end
```
補足
- User.authenticate(...)
  - → ユーザー認証を行うためのクラスメソッドです。
  - （例：SorceryやDeviseなどの認証ライブラリで用意されていることが多い）
- params[:email]
  - → フォームから送られた「メールアドレス」の値。
- params[:password]
  - → フォームから送られた「パスワード」の値。
- user = ...
  - → 認証に成功すれば、そのユーザー情報が user に代入される。
  - 認証に失敗すれば nil（空っぽ）が返る。
- auto_login(user) は そのユーザーをログイン済みにするショートカット
---

#### 認証処理（裏側）

1. DBからユーザーを取得
2. salt を取り出し、入力パスワードを同じ方法で暗号化
3. DBの `crypted_password` と比較
4. 一致すればログイン成功

---

## 🌟 まとめ

* **必要性** → 認証処理を安全に導入するため
* **処理** → 仮想属性`password`、暗号化・salt生成、認証メソッド提供
* **データの流れ**

  * 登録時 → フォーム入力 → コントローラー → モデル保存（暗号化処理）
  * ログイン時 → フォーム入力 → コントローラー → Sorcery認証処理 → 一致判定

👉 **フォーム入力の裏側では、学習用コード例（`User.new(...).save`）と同じ処理が実行されている**

---
# 補足
良いところに気づきましたね 👍
`user` と `@user` の違いがポイントです。

---

## 1. `user` と `@user` の違い

* `user`
  → **ローカル変数**
  → そのメソッド（ここでは `create` アクション）の中だけで使える。
  → ビューには渡らない。

* `@user`
  → **インスタンス変数**
  → コントローラーからビュー（HTMLを作るテンプレート）に値を渡すときに使う。
  → 例: `@user = User.new` をすると、その `@user` をフォームで使える。

---

## 2. このコードで `user` が使われている理由

`SessionsController#create` の役割は「ログイン処理」を行って、**すぐにリダイレクトする** ことです。

* 成功したら `root_path` へ飛ばす
* 失敗したら `new` を表示する（ここでは `@user` を使わず、メッセージだけ出している）

つまり、ビュー側に「ユーザーの情報を渡して表示する必要がない」から、
**ローカル変数の `user` で十分** なんです。

---

## 3. もし `@user` を使うなら？

例えば「ログインフォームに入力エラーがあったときに、入力済みの値をフォームに戻したい」など、ビューに渡す必要がある場合は `@user` を使います。

```ruby
def create
  @user = User.authenticate(params[:email], params[:password])
  if @user
    auto_login(@user)
    redirect_to root_path, notice: "ログイン成功"
  else
    flash.now[:alert] = "メールアドレスまたはパスワードが違います"
    render :new  # ← このビューで @user を参照できる
  end
end
```

---

## 4. まとめ

* `user`（ローカル変数）: メソッド内だけで使う、一時的な処理用
* `@user`（インスタンス変数）: ビューにも渡す必要があるときに使う

👉 今の `SessionsController#create` では「ビューにユーザーを渡す必要がない」ので、`@user` ではなく `user` になっている、というわけです。

---
