# マイグレーションファイルを編集するなら？


---

## 結論まとめ（まずここ）

|状況|マイグレーションファイルを編集していい？|
|---|---|
|**まだ `rails db:migrate` を実行していない**|✅ **編集してOK**|
|**すでに `rails db:migrate` を実行済み（他の環境・チーム共有あり）**|❌ **編集NG。新しいマイグレーションを作る**|

---

## なぜ分かれるのか（超重要）

マイグレーションは **「DBの変更履歴」** だからです。

- 既に実行済みのマイグレーションを編集すると  
    👉 **履歴と実体のDBがズレる**
    
- 特にチーム開発・本番環境では **事故の元**
    

---

## ケース①：まだ migrate していない場合（OK）

```bash
rails db:migrate:status
```

で `down` になっているなら：

```ruby
create_table :post_tags do |t|
  t.references :post, null: false, foreign_key: true
  t.references :tag, null: false, foreign_key: true

  t.timestamps
end

add_index :post_tags, [:post_id, :tag_id], unique: true
```

👉 **そのまま編集して問題なし**

この状態で migrate すれば、  
「テーブル作成 + 一意制約」が一発で適用されます。

---

## ケース②：すでに migrate 済みの場合（NG）

すでに `up` になっているなら👇

```bash
up     2025xxxxxx  CreatePostTags
```

❌ **このファイルを編集してはいけません**

### 正しい対応：新しいマイグレーションを作る

```bash
rails g migration AddUniqueIndexToPostTags
```

```ruby
class AddUniqueIndexToPostTags < ActiveRecord::Migration[7.0]
  def change
    add_index :post_tags, [:post_id, :tag_id], unique: true
  end
end
```

👉 これが **Rails的にも現場的にも正解**

