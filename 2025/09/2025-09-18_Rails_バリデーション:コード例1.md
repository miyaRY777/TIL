
---

# Rails バリデーション学習メモ

## ✅ 基本のバリデーション

### コード例

```ruby
class Board < ApplicationRecord
  validates :title, presence: true, uniqueness: true
  validates :status, presence: true
end
```

---

### `presence: true`

* 値が **空（nilや空文字）でないこと** を保証するバリデーション。
* 入力必須項目にしたいときに使う。

例:

```ruby
board = Board.new(title: "", status: "公開")
board.valid? # => false （titleが空なので無効）
```

---

### `uniqueness: true`

* 値が **他のレコードと重複しないこと** を保証するバリデーション。
* 一意性を担保するのに使う。
* ただしDB側で **ユニーク制約を併用するのがベストプラクティス**。

例:

```ruby
Board.create!(title: "同じタイトル", status: "公開")
board = Board.new(title: "同じタイトル", status: "下書き")
board.valid? # => false （titleが重複しているため無効）
```


---

## ✅ 複数カラムの一意性

### コード例

```ruby
validates :title, uniqueness: { scope: :status }
```

👉 `title` と `status` の **セット** がユニークであることを保証する。
- uniqueness: { scope: :status } = 「title の一意性を、status ごとにチェック」
  - scope = 検証する範囲・条件
  - 「この条件内でだけ一意であることを保証したい」ときに使う。

### OK/NGのイメージ

| title  | status    | 保存できる？ | 理由               |
| ------ | --------- | ------ | ---------------- |
| Ruby入門 | draft     | ✅      | 初回なのでOK          |
| Ruby入門 | published | ✅      | statusが違うのでOK    |
| Ruby入門 | draft     | ❌      | 1行目と同じ組み合わせなのでNG |

### DB側の制約も追加する

```ruby
# db/migrate/xxxx_add_unique_index_to_boards_title_status.rb
class AddUniqueIndexToBoardsTitleStatus < ActiveRecord::Migration[7.1]
  def change
    add_index :boards, [:title, :status], unique: true
  end
end
```
解説
- add_index = DBに検索用の「索引」を追加する命令。
- [:title, :status] = 2つのカラムを組み合わせた複合インデックス。
- unique: true = この組み合わせが重複すると保存を禁止する。
  - つまり、その組み合わせを 一意制約（重複禁止）にする
- Railsのバリデーションだけでなく、DBでも一意性を担保するのが安全！
- インデックスとは、本の巻末にある「索引」のイメージ
  - → 「○○という単語は 123ページ」

---

## ✅ `status` に対する必須チェック

### コード例

```ruby
validates :status, presence: true
```

* `status` が **nilや空文字でないこと** を保証する。

例:

```ruby
board = Board.new(title: "記事タイトル", status: nil)
board.valid? # => false
board.errors.full_messages # => ["Status can't be blank"]
```

### enumと組み合わせると便利

```ruby
class Board < ApplicationRecord
  enum status: { draft: 0, published: 1 }
  validates :status, presence: true
end
```

👉 enumを使うと、`board.draft!` / `board.published!` のように状態を管理できる。
👉 `presence: true` で nil防止もしっかりできる。

---

## ✅ RSpecでの確認例

```ruby
# spec/models/board_spec.rb
require 'rails_helper'

RSpec.describe Board, type: :model do
  describe 'バリデーション' do
    it 'statusがnilなら無効' do
      board = Board.new(title: '記事', status: nil)
      expect(board).to be_invalid
      board.validate
      expect(board.errors[:status]).to include("can't be blank")
    end

    context 'titleの一意性（statusでスコープ）' do
      before { Board.create!(title: 'Ruby入門', status: 'draft') }

      it '同じstatus内で同じtitleは無効' do
        dup = Board.new(title: 'Ruby入門', status: 'draft')
        expect(dup).to be_invalid
        dup.validate
        expect(dup.errors[:title]).to include('has already been taken')
      end

      it 'statusが違えば同じtitleでも有効' do
        other = Board.new(title: 'Ruby入門', status: 'published')
        expect(other).to be_valid
      end
    end
  end
end
```

---

## ✅ 学習ポイントまとめ

* `presence: true` → **空じゃダメ**
* `uniqueness: true` → **重複しちゃダメ**
* `uniqueness: { scope: :status }` → **「title × status」の組み合わせで一意にする**
* DBにもユニーク制約をつけるのが必須
* `status` は `enum` と一緒に使うと実用的

---
