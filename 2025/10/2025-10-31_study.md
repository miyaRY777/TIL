#daily

## 今日取り組んだタスク

- [ ] 中間試験：Railsっというより、エラー解決
- [ ] Web技術の基本
- [ ] スッキリわかるSQL入門

---
---
## 一言

今まで、ActiveRecord::ConnectionNotEstablishedというエラーに遭遇したことがなかったので
解決するまでに随分時間がかかりました💦
PostgreSQLのバージョン変化による、パスが変わってしまったのが原因でした！
明日からまた課題の続きを取り組みます！

---
---
## 学習内容
### Ruby / Rails

### テーマ（What）


![[スクリーンショット 2025-10-31 23.43.33.png]]

説明：

このエラーは **Rails が PostgreSQL サーバーに接続できない**ときに発生します！

「db」というホスト名を解決できないのは、**Docker ネットワークまたは DB コンテナの異常終了**が原因です！

---

###  疑問点（Why）

- どこが理解できていないのか？

A：

初めて遭遇したエラーなので、解決方法がわかりませんでしたorz

### 位置づけ（Where／When）

> このテーマは“全体のどこ”に関係するのか？
> 
> いつ・どんな場面で重要になるのか？

- この知識はどの領域（例：Web基礎／Rails／通信／DB設計）に属する？

|**領域**|**関係性**|
|---|---|
|🧩 通信／ネットワーク|ホスト名（DNS）解決やDocker内ネットワーク設定に関係|
|⚙️ インフラ／開発環境構築|Docker Composeのサービス設定・ボリューム管理が原因になりやすい|
|💎 Rails設定|config/database.yml 内の host: が間違っている場合にも発生|
|🗃 DB設計（間接的）|DBの構造ではなく、アプリからDBへ接続するための“接続情報”に関係|

- どんなタイミング（例：実装時／設計時／トラブル時）で役立つ？

|**フェーズ**|**説明**|
|---|---|
|🏗 開発環境構築時|Docker Composeを立ち上げた際などに発生しやすい|
|🧰 トラブルシューティング時|rails db:migrateやrails sなどでDB接続が必要なタイミング|
|🚀 デプロイ時|本番・ステージング環境で環境変数の設定ミスなどにより発生|

---

### 解決までのアプローチ（How）

> 調べ方・試行・仮説・失敗・再挑戦などを簡潔に

- 調べた方法（検索・ChatGPT・書籍など）：
    
    - chatGPT
    - Google：「ActiveRecord::ConnectionNotEstablished」
    - Qiita：[https://qiita.com/kouhei-ioroi/items/0d3bf1ad7c319c536193](https://qiita.com/kouhei-ioroi/items/0d3bf1ad7c319c536193)
- 試したこと／うまくいかなかったこと：
    

１：[原因] DBコンテナ（例：PostgreSQL）がまだ起動していないのではないかと予想

実行：

docker compose ps　で、DBコンテナを確認したところ

```ruby
# STATUS
Restarting (1) 34 seconds ago
```

説明；

これを意味しているのは

DBコンテナが起動しようとしたものの、何らかのエラーによってすぐに終了してしまい、Dockerによって自動的に再起動（Restart）されている状態を示しています！

１-２：DBコンテナのログを確認し、次にそのエラーについて特定する

```ruby
# docker compose logs db を打ち込む

See <https://github.com/docker-library/postgres/issues/37> for a (long) discussion around this process, and suggestions for how to do so. 
Error: in 18+, these Docker images are configured to store database data in a format which is compatible with "pg_ctlcluster" 
(specifically, using major-version-specific directory names). 
This better reflects how PostgreSQL itself works, and how upgrades are to be performed. 

See also <https://github.com/docker-library/postgres/pull/1259> 

---

Counter to that, there appears to be PostgreSQL data in:
/var/lib/postgresql/data (unused mount/volume)

This is usually the result of upgrading the Docker image without upgrading the underlying database using "pg_upgrade" 
(which requires both versions).

The suggested container configuration for 18+ is to place a single mount at /var/lib/postgresql 
which will then place PostgreSQL data in a subdirectory, allowing usage of "pg_upgrade --link" without mount point boundary issues.

```

説明：

全文翻訳：

```
詳しくは <https://github.com/docker-library/postgres/issues/37>
 を参照してください。
このプロセス（＝データ格納方法やアップグレード方法）についての長い議論と、いくつかの提案が掲載されています。

エラー:
PostgreSQL 18 以降では、Docker イメージは
"pg_ctlcluster" と互換性のある形式でデータベースを保存するように設定されています。
（具体的には「メジャーバージョンごとのディレクトリ名」を使います）

これは、PostgreSQL 本体の仕組みやアップグレードの方法により近い形です。

詳細は <https://github.com/docker-library/postgres/pull/1259も参照してください。>

---

ただし、次の場所に PostgreSQL データが存在するようです：

/var/lib/postgresql/data
（これは現在使われていないマウント／ボリュームです）

これは通常、Docker イメージをアップグレードしたのに、
データベース自体を「pg_upgrade」でアップグレードしていない場合に発生します。
（pg_upgrade は旧バージョンと新バージョンの両方を必要とします）

---

PostgreSQL 18 以降の推奨設定は：

/var/lib/postgresql に 1 つだけマウントポイントを設定することです。
こうすると、PostgreSQL のデータがサブディレクトリに保存されるようになります。

これにより、pg_upgrade --link コマンドを使用してもマウントポイントの境界問題が発生しません。
```

- 得た理解・気づき：

わかったこと：

PostgreSQL 18 からはデータフォルダの構造が変わり、
古いフォルダ（`/var/lib/postgresql/data`）をそのまま使うとエラーとなる！

解決策：

①：docker-compose.ymlを編集する

```docker
# docker-compose.yml
# 変更前
volumes:
  - postgres_data:/var/lib/postgresql/data

# 変更後
volumes:
	- postgres_data:/var/lib/postgresql
```

説明：

|比較|旧構造（〜v17）|新構造（v18〜）|
|---|---|---|
|データ格納先|`/var/lib/postgresql/data`|`/var/lib/postgresql/data/18/main`|
|Dockerマウント推奨先|`/var/lib/postgresql/data`|✅ `/var/lib/postgresql`|
|理由|data直下に保存|バージョンごとに自動生成されるため|

②：コンテナを再度立ち上げる

```docker
# 🧭 PostgreSQL 18対応後のリセット＆再構築 手順

# ① すべてのコンテナを停止・削除
# 古い設定のコンテナとボリュームを完全に消します
docker compose down -v
# ✅ -v オプションを付けることで、古いDBデータ（ボリューム）も削除します

# ② 新しい構成で再ビルド
# もしDockerfileなどを変更していれば、イメージを再ビルドします
docker compose build
# （変更がなければスキップしてOK）

# ③ 新しい設定で起動
# 修正した docker-compose.yml に基づいてコンテナを立ち上げます
docker compose up

# 起動後に以下で確認：
docker compose ps
# → db が「Up」になっていればOK！
```

---

### 結果・学んだこと（What I Found）

> 最終的に理解した内容・要点・教訓

- まとめ：

A:

PostgreSQLサーバーに接続できないことで発生したエラーで

原因は、PostgreSQLのバージョン変化により、データフォルダの構造が変わってしまって、Dockerのマウント先のパスにありました **docker-composeを適切に編集することで、解決しました**

追記：

その後

ActiveRecord::NoDatabaseError connection to server at "172.20.0.2", port 5432
failed: FATAL: database "" does not exist

っとエラーが発生しましたが、データベースを作成してないのが原因だったので
docker compose exec web rails db:create で、DB作成して解決しました！（忘れずに、docker compose exec web rails db:migrate）




---
### SQL

##### SUBSTRING関数

説明：
文字列に対して
「何文字目から何文字分」という指定をして、文字列の一部分を抽出することができる！

基本形：
```sql
SUBSTRING(文字列を表す列, 抽出を開始する位置, 抽出する文字の数)
```

具体例：

![[スクリーンショット 2025-10-31 21.50.16.png]]

SQL：
```sql
SELECT * FROM 家計簿
 WHERE SUBSTRING(費目, 1, 3) LIKE '%費%'
```

出力：
```sql
|日付|費目|メモ|入金額|出金額|

|2024-02-03|食費|コーヒーを購入|0|380|
|2024-02-14|交際費|同期会の会費|0|5000|
```

補足
> 「費目カラムの**先頭3文字以内に『費』が含まれる**行だけを取得する」


##### CONCAT関数

説明：
複数の文字列を結合するための関数です！

基本形：
```sql
CONCAT(文字列, 文字列,・・・)
```


具体例：費目とメモをつなげて抽出したい

![[スクリーンショット 2025-10-31 22.41.42.png]]

SQL：
```sql
SELECT CONCAT(費目, ':' || メモ) FROM 家計簿
```

補足：
1. ':' || メモ
    → || は「文字列結合演算子」
    メモ の前に「:」をつける処理をしている！
    例： 'コンビニ' → ':コンビニ'
    
2. CONCAT(費目, ':' || メモ)
    → 費目（例：'食費'）と ':コンビニ' を結合！
    結果 → '食費:コンビニ'

出力：
```sql
|CONCAT|

|食費:コーヒーを購入|
|給料:1月の給料|
|教養娯楽費:書籍を購入|
|交際費:同期会の会費|
|水道光熱費:1月の電気代|
```


##### ROUND関数

説明：
指定した位置で四捨五入をした結果を返す関数のことです！

基本形：
```sql
ROUND(数値を表す列, 有効とする桁数)
```


具体例：100円単位の出金額を取得する（四捨五入）

![[スクリーンショット 2025-10-31 23.14.15.png]]

SQL：
```sql
SELECT 出金額, ROUND(出金額, -2) AS 百円単位の出金額
  FROM 家計簿
```

補足
ROUND関数に「−２」を渡すと
下２桁、つまり、10の位で四捨五入を行う！


出力：
```sql
|出金額|百円単位の出金額|

|380|400|
|0|0|
|2800|2800|
|5000|5000|
|7560|7600|
```


---
### Web技術の基本

##### ポットキャスト

説明：
Webサーバー上に
音楽や動画などを配置し、RSSを通してWeb上に公開する手法のこと！


---
---
## 学んだこと

SQL
- SUBSTRING関数について
- CONCAT関数について
Web技術の基本
- ポットキャスト
Rails
- ActiveRecord::ConnectionNotEstablishedにおけるエラーの対処の仕方について


---
---
## 教材

- Web技術の基本
- スッキリわかるSQL入門


---
---
##### ⏳ 学習時間: 時間  
##### 🌱 コミット数: １コミット
