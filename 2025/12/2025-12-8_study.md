#daily

## 今日取り組んだタスク

- [ ] スッキリわかるSQL入門
- [ ] 読書：エンジニアの知的生産術

---
## 一言

ここ3日ぐらいカリキュラムを進めていないので、明日から頑張ります💦

---
## 学習内容

### SQL
##### ロックの活用

##### 明示的なロック

説明；

DBMSがトランザクションの分離性を確保するために、自動的に行にロックをかけてました！

なので、具体的に「いつ」「どの行に対して」ロックをするという指示は必要ありませんでした！

ただ、その一方

SQL文を使って、指定した対象を明示的にロックをすることができます！

明示的なロックの種類

```sql
行ロック：ある特定の行だけをロックする
表ロック：ある特定のテーブル全体をロックする
データベースロック：データベース全体をロックする
```

ロックをかけるとき、その制限の強さを指定可能

- **排他ロック (Exclusive Lock / Write Lock)**:
    - そのデータに対する**読み取り**と**書き込み**の両方を制限します
    - 一度排他ロックがかかると、他のトランザクションはそのロックが解放されるまで、読み取りも書き込みも一切行えなくなります
    - 主にデータの更新時（`INSERT`, `UPDATE`, `DELETE`）に使用されます
- **共有ロック (Shared Lock / Read Lock)**:
    - 他のトランザクションによる**読み取り**は許可しますが、**書き込み（更新）**は禁止します
    - 複数のトランザクションが同時に共有ロックを取得し、データを並行して読み込むことができます
    - データの読み取り時（`SELECT`）に使用され、そのデータが読み取り中に他の誰かに更新されないことを保証（一貫性の確保）します

①行ロックの取得：`SELECT … FOR UPDATE`

説明：

通常、SELECT文で選択した行には自動的に共有ロックがかかります！

しかし

SELECT文の末尾にFOR UPDATEを追加すると、排他ロックがかかり

他のトランザクションからは該当行のデータを書き換えられなくなります

```sql
SELECT ~ FOR UPDATE (NOWAIT)
```

※NOWAITをつけると、すでにロックされていたら、即エラーにする！、待ちたくないアプリに有効です！

具体例：2月以降の行をロックして集計

```sql
BEGIN;
SELECT * FROM 家計簿
 WHERE 日付 >= '2024-02-01'
   FOR UPDATE;
-- 集計処理1
SELECT ～ ;
-- 集計処理2
SELECT ～ ;
-- 集計処理3
SELECT ～ ;
COMMIT;

```

補足

WHERE句で選ばれたその行だけ排他ロックがかかります！

このとき、他のトランザクションはその行の更新ができません！

ロックが解除されるのは、トランザクション終了時です！

使い所として

集計処理のように途中でデータが変わると困る処理に使います！

②表ロックの取得

説明：

LOCK TABLE命令を利用することで、ある特定の表全体をロックすることができます！

明示的な表ロックの取得

```sql
LOCK TABLE テーブル名 IN モード名 MODE (NOWAIT)
```

※モード名：排他ロック（EXCLUSIVE）共有ロック（SHARE）

※NOWAITをつけると、すでにロックされていたら、即エラーにする！、待ちたくないアプリに有効です！

具体例：

```sql
BEGIN;
LOCK TABLE 家計簿 IN EXCLUSIVE MODE;
-- 集計処理1
SELECT ～ ;
-- 集計処理2
SELECT ～ ;
-- 集計処理3
SELECT ～ ;
COMMIT;
```

補足

これは、テーブル全体を排他ロックすることで

他の人から読み取りはできるが、更新することはできないようにしています！

一見、表ごとに排他ロックをかければ

トランザクション処理中に、他の人のトランザクションにデータを操作される心配はなくなります、、、

しかし

大勢の人が同時に利用できる！という利点は無くなってしまいます💦

それゆえ、ロックは必要最小限にする必要があります！

---
## 学んだこと

- 明示的にロックすること！
	- 行をロック
	- 表をロック

---
## 教材

- スッキリわかるSQL入門
- エンジニアの知的生産術

---
##### ⏳ 学習時間: 6時間  
##### 🌱 コミット数: １コミット