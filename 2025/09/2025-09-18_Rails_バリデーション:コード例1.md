
---

# Rails ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’ãƒ¡ãƒ¢

## âœ… åŸºæœ¬ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### ã‚³ãƒ¼ãƒ‰ä¾‹

```ruby
class Board < ApplicationRecord
  validates :title, presence: true, uniqueness: true
  validates :status, presence: true
end
```

---

### `presence: true`

* å€¤ãŒ **ç©ºï¼ˆnilã‚„ç©ºæ–‡å­—ï¼‰ã§ãªã„ã“ã¨** ã‚’ä¿è¨¼ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
* å…¥åŠ›å¿…é ˆé …ç›®ã«ã—ãŸã„ã¨ãã«ä½¿ã†ã€‚

ä¾‹:

```ruby
board = Board.new(title: "", status: "å…¬é–‹")
board.valid? # => false ï¼ˆtitleãŒç©ºãªã®ã§ç„¡åŠ¹ï¼‰
```

---

### `uniqueness: true`

* å€¤ãŒ **ä»–ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨é‡è¤‡ã—ãªã„ã“ã¨** ã‚’ä¿è¨¼ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
* ä¸€æ„æ€§ã‚’æ‹…ä¿ã™ã‚‹ã®ã«ä½¿ã†ã€‚
* ãŸã ã—DBå´ã§ **ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½µç”¨ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**ã€‚

ä¾‹:

```ruby
Board.create!(title: "åŒã˜ã‚¿ã‚¤ãƒˆãƒ«", status: "å…¬é–‹")
board = Board.new(title: "åŒã˜ã‚¿ã‚¤ãƒˆãƒ«", status: "ä¸‹æ›¸ã")
board.valid? # => false ï¼ˆtitleãŒé‡è¤‡ã—ã¦ã„ã‚‹ãŸã‚ç„¡åŠ¹ï¼‰
```


---

## âœ… è¤‡æ•°ã‚«ãƒ©ãƒ ã®ä¸€æ„æ€§

### ã‚³ãƒ¼ãƒ‰ä¾‹

```ruby
validates :title, uniqueness: { scope: :status }
```

ğŸ‘‰ `title` ã¨ `status` ã® **ã‚»ãƒƒãƒˆ** ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã€‚
- uniqueness: { scope: :status } = ã€Œtitle ã®ä¸€æ„æ€§ã‚’ã€status ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ã€
  - scope = æ¤œè¨¼ã™ã‚‹ç¯„å›²ãƒ»æ¡ä»¶
  - ã€Œã“ã®æ¡ä»¶å†…ã§ã ã‘ä¸€æ„ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãŸã„ã€ã¨ãã«ä½¿ã†ã€‚

### OK/NGã®ã‚¤ãƒ¡ãƒ¼ã‚¸

| title  | status    | ä¿å­˜ã§ãã‚‹ï¼Ÿ | ç†ç”±               |
| ------ | --------- | ------ | ---------------- |
| Rubyå…¥é–€ | draft     | âœ…      | åˆå›ãªã®ã§OK          |
| Rubyå…¥é–€ | published | âœ…      | statusãŒé•ã†ã®ã§OK    |
| Rubyå…¥é–€ | draft     | âŒ      | 1è¡Œç›®ã¨åŒã˜çµ„ã¿åˆã‚ã›ãªã®ã§NG |

### DBå´ã®åˆ¶ç´„ã‚‚è¿½åŠ ã™ã‚‹

```ruby
# db/migrate/xxxx_add_unique_index_to_boards_title_status.rb
class AddUniqueIndexToBoardsTitleStatus < ActiveRecord::Migration[7.1]
  def change
    add_index :boards, [:title, :status], unique: true
  end
end
```
è§£èª¬
- add_index = DBã«æ¤œç´¢ç”¨ã®ã€Œç´¢å¼•ã€ã‚’è¿½åŠ ã™ã‚‹å‘½ä»¤ã€‚
- [:title, :status] = 2ã¤ã®ã‚«ãƒ©ãƒ ã‚’çµ„ã¿åˆã‚ã›ãŸè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚
- unique: true = ã“ã®çµ„ã¿åˆã‚ã›ãŒé‡è¤‡ã™ã‚‹ã¨ä¿å­˜ã‚’ç¦æ­¢ã™ã‚‹ã€‚
  - ã¤ã¾ã‚Šã€ãã®çµ„ã¿åˆã‚ã›ã‚’ ä¸€æ„åˆ¶ç´„ï¼ˆé‡è¤‡ç¦æ­¢ï¼‰ã«ã™ã‚‹
- Railsã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã§ãªãã€DBã§ã‚‚ä¸€æ„æ€§ã‚’æ‹…ä¿ã™ã‚‹ã®ãŒå®‰å…¨ï¼
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã¯ã€æœ¬ã®å·»æœ«ã«ã‚ã‚‹ã€Œç´¢å¼•ã€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
  - â†’ ã€Œâ—‹â—‹ã¨ã„ã†å˜èªã¯ 123ãƒšãƒ¼ã‚¸ã€

---

## âœ… `status` ã«å¯¾ã™ã‚‹å¿…é ˆãƒã‚§ãƒƒã‚¯

### ã‚³ãƒ¼ãƒ‰ä¾‹

```ruby
validates :status, presence: true
```

* `status` ãŒ **nilã‚„ç©ºæ–‡å­—ã§ãªã„ã“ã¨** ã‚’ä¿è¨¼ã™ã‚‹ã€‚

ä¾‹:

```ruby
board = Board.new(title: "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«", status: nil)
board.valid? # => false
board.errors.full_messages # => ["Status can't be blank"]
```

### enumã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ä¾¿åˆ©

```ruby
class Board < ApplicationRecord
  enum status: { draft: 0, published: 1 }
  validates :status, presence: true
end
```

ğŸ‘‰ enumã‚’ä½¿ã†ã¨ã€`board.draft!` / `board.published!` ã®ã‚ˆã†ã«çŠ¶æ…‹ã‚’ç®¡ç†ã§ãã‚‹ã€‚
ğŸ‘‰ `presence: true` ã§ nilé˜²æ­¢ã‚‚ã—ã£ã‹ã‚Šã§ãã‚‹ã€‚

---

## âœ… RSpecã§ã®ç¢ºèªä¾‹

```ruby
# spec/models/board_spec.rb
require 'rails_helper'

RSpec.describe Board, type: :model do
  describe 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³' do
    it 'statusãŒnilãªã‚‰ç„¡åŠ¹' do
      board = Board.new(title: 'è¨˜äº‹', status: nil)
      expect(board).to be_invalid
      board.validate
      expect(board.errors[:status]).to include("can't be blank")
    end

    context 'titleã®ä¸€æ„æ€§ï¼ˆstatusã§ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰' do
      before { Board.create!(title: 'Rubyå…¥é–€', status: 'draft') }

      it 'åŒã˜statuså†…ã§åŒã˜titleã¯ç„¡åŠ¹' do
        dup = Board.new(title: 'Rubyå…¥é–€', status: 'draft')
        expect(dup).to be_invalid
        dup.validate
        expect(dup.errors[:title]).to include('has already been taken')
      end

      it 'statusãŒé•ãˆã°åŒã˜titleã§ã‚‚æœ‰åŠ¹' do
        other = Board.new(title: 'Rubyå…¥é–€', status: 'published')
        expect(other).to be_valid
      end
    end
  end
end
```

---

## âœ… å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆã¾ã¨ã‚

* `presence: true` â†’ **ç©ºã˜ã‚ƒãƒ€ãƒ¡**
* `uniqueness: true` â†’ **é‡è¤‡ã—ã¡ã‚ƒãƒ€ãƒ¡**
* `uniqueness: { scope: :status }` â†’ **ã€Œtitle Ã— statusã€ã®çµ„ã¿åˆã‚ã›ã§ä¸€æ„ã«ã™ã‚‹**
* DBã«ã‚‚ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ã¤ã‘ã‚‹ã®ãŒå¿…é ˆ
* `status` ã¯ `enum` ã¨ä¸€ç·’ã«ä½¿ã†ã¨å®Ÿç”¨çš„

---
